---
layout: post
title: Dockerå®¹å™¨/etc/hostsæ–‡ä»¶è¢«é‡ç½®Bug
index_img: /images/post/bug-diary-cover.png
date: 2022-08-16 16:13:34
categories:
- Bugæ—¥è®°
tags:
- Docker
- Bug
---

## 1. Bugå‘ç°

å‰äº›æ—¥å­ï¼Œå…¬å¸æœ‰ä¸ªå°†Awvs14æ‰“åŒ…ä¸ºä¸€ä¸ªç‹¬ç«‹çš„Dockerå®¹å™¨å¹¶æš´éœ²æ¥å£å’Œæ•°æ®åº“ç»™å…¶ä»–æœåŠ¡åšæµ‹è¯•çš„éœ€æ±‚

å‡ºäºæµ‹è¯•ç›®çš„ï¼Œä¾¿åœ¨ [ğŸ”°é›¨è‹â„’ğŸ”°](https://www.ddosi.org/) å¤§ä½¬çš„åšå®¢ä¸­æ‰¾äº†ä¸ªAWVS14çš„Linuxç ´è§£ç‰ˆ

å…·ä½“çš„ç ´è§£æ•™ç¨‹ä»¥åŠç ´è§£æ–‡ä»¶ç­‰å¯ä»¥å‚è€ƒï¼š[Awvsç ´è§£ç‰ˆ14.7.220228146|awvs cracked](https://www.ddosi.org/awvs-14-7/)ï¼Œæœ¬ç¯‡æ—¥è®°åªä¸“æ³¨Bugè®°å½•

æ ¹æ®å¤§ä½¬æä¾›çš„å®‰è£…æ•™ç¨‹ä¸€è·¯èµ°ä¸‹æ¥é¡ºé¡ºåˆ©åˆ©å®‰è£…å®Œæˆ

æ¥ä¸‹æ¥è‡ªç„¶è€Œç„¶çš„å°±æ˜¯å¯¼å‡ºå®¹å™¨æ¨é€åˆ°æœåŠ¡å™¨è¿›è¡Œæµ‹è¯•

> å°æç¤ºï¼š
>
> å®¹å™¨å†…å®‰è£…Awvséœ€è¦å®‰è£…Awvsæ‰€éœ€çš„ä¾èµ–ï¼Œå¯ä»¥æ ¹æ®Awvsç‰ˆæœ¬å»æŸ¥çœ‹å®˜æ–¹çš„æ–‡æ¡£å®‰è£…ä¾èµ–ï¼Œåœ¨æœ¬ç¯‡æ—¥è®°ä¸­å®¹å™¨ä½¿ç”¨çš„æ˜¯ `ubuntu20.04` åŸºç¡€é•œåƒ
> 
> Awvsçš„ä¾èµ–å®‰è£…å¦‚ä¸‹ï¼š
>
> ```shell
> apt install -y libxdamage1 libgtk-3-0 libasound2 libnss3 libxss1 libx11-xcb1 libxcb-dri3-0 libgbm1 libdrm2 libxshmfence1 sudo
> ```

ä½†æ˜¯æ¨é€åˆ°æœåŠ¡å™¨åä½¿ç”¨ `docker run` å‘½ä»¤å¯åŠ¨å®¹å™¨æ—¶æ€ªäº‹å‘ç”Ÿäº†ï¼Œæ‰«æä»»åŠ¡ä¸€ç›´æç¤ºå¯åŠ¨å¤±è´¥

æ’é™¤Awvså®¹å™¨çš„è¾“å‡ºå‘ç°æ¯å½“ä»»åŠ¡å¯åŠ¨æ—¶éƒ½ä¼šæç¤ºè®¸å¯è¯é”™è¯¯ï¼Œèµ·åˆä»¥ä¸ºæ˜¯ç ´è§£æ–‡ä»¶çš„é—®é¢˜ï¼ˆå› ä¸ºå®‰è£…åå°±ç›´æ¥æ‰“åŒ…æ¨é€åˆ°æœåŠ¡å™¨æµ‹è¯•ï¼Œæ²¡æœ‰åœ¨æœ¬åœ°å¯åŠ¨æµ‹è¯•è¿‡ï¼‰

äºæ˜¯é‡æ–°æ„å»ºä¸€ä¸ªå®¹å™¨ï¼Œåœ¨æœ¬åœ°æµ‹è¯•æ²¡é—®é¢˜åæ¨é€åˆ°æœåŠ¡å™¨ï¼Œä½†ä»»åŠ¡å¯ä¹Ÿæ˜¯ä¸€ç›´å¤±è´¥ï¼Œé”™è¯¯åŸå› ä¹ŸåŒæ ·æ˜¯è®¸å¯è¯é”™è¯¯

........

æœ‰æ€€ç–‘è¿‡æ˜¯ç½‘ç»œé—®é¢˜ï¼Œæœ‰æ€€ç–‘è¿‡Dockerç‰ˆæœ¬é—®é¢˜ï¼Œæœ‰æ€€ç–‘è¿‡æ˜¯Awvsè®¸å¯è¯ä¸Macåœ°å€ç›¸å…³ç­‰ç­‰ï¼Œè€½æäº†ä¸€ä¸ªå‘¨ï¼Œç„¦å¤´çƒ‚é¢å‡†å¤‡æ”¾å¼ƒä¹‹é™…æ‰“ç®—å¯¹æ¯”ä¸‹æœ¬åœ°å®¹å™¨å’Œæµ‹è¯•æœåŠ¡ä¸Šçš„å®¹å™¨å†…éƒ¨æ–‡ä»¶æœ‰ä»€ä¹ˆä¸ä¸€æ ·

ä¹‹å‰ä»æœªæ€€ç–‘è¿‡æ˜¯å®¹å™¨æ–‡ä»¶ä¸ä¸€è‡´å¯¼è‡´çš„Bugï¼Œå› ä¸ºåœ¨æˆ‘çš„è®¤çŸ¥é‡Œï¼Œå®¹å™¨å¯¼å‡ºåå†å¯¼å…¥å†è¿è¡Œå†…éƒ¨æ–‡ä»¶æ˜¯ä¸ä¼šå˜åŒ–çš„ï¼Œå°±åƒä¼ ç»Ÿè™šæ‹Ÿæœºä¸€æ ·

ä½†æ˜¯å¯¹æ¯”è¿‡åï¼Œå‘ç°æµ‹è¯•æœåŠ¡å™¨ä¸Šçš„ `/etc/hosts` æ–‡ä»¶ä¸æœ¬åœ°æ‰“åŒ…çš„å®¹å™¨ä¸ä¸€è‡´

æ ¹æ®å¤§ä½¬çš„ Awvs14 Linux ç‰ˆå®‰è£…æ•™ç¨‹ï¼Œåœ¨ç¬¬6æ­¥æ—¶éœ€è¦ä¿®æ”¹ `/etc/hosts` æ–‡ä»¶

![](images/post/docker-container-etc-hosts-file-reset-bug/01.png)

è¿™ä¸€æ­¥åœ¨æ­£å¸¸çš„Linuxæ“ä½œç³»ç»Ÿä¸Šæ“ä½œæ˜¯æ²¡é—®é¢˜çš„ï¼Œæ‰€ä»¥ç†æ‰€å½“ç„¶çš„ä»¥ä¸ºæ‰“åŒ…åçš„ `/etc/hosts` æ–‡ä»¶ä¹Ÿä¸ä¼šæ”¹å˜

ç”±äº `/etc/hosts` ä¸­ä¸ç ´è§£ç›¸å…³çš„å†…å®¹è¢«æ¸…é™¤äº†ï¼Œæ‰€ä»¥AWVSä»»åŠ¡å› ä¸ºè®¸å¯è¯é—®é¢˜å¯åŠ¨å¤±è´¥ä¹Ÿæ˜¯æƒ…ç†ä¹‹ä¸­äº†


## 2. ä¸ºä»€ä¹ˆ /etc/hosts ä¼šè¢«é‡ç½®ï¼Ÿ

å‚è€ƒDockerå®˜æ–¹æ–‡æ¡£ï¼š[https://docs.docker.com/engine/reference/run/#managing-etchosts](https://docs.docker.com/engine/reference/run/#managing-etchosts)

![](images/post/docker-container-etc-hosts-file-reset-bug/02.png)

> ä½ çš„å®¹å™¨åœ¨/etc/hostsä¸­ä¼šæœ‰å‡ è¡Œï¼Œå®ƒä»¬å®šä¹‰äº†å®¹å™¨æœ¬èº«çš„ä¸»æœºåä»¥åŠlocalhostå’Œå…¶ä»–ä¸€äº›å¸¸è§çš„ä¸œè¥¿ã€‚--add-hostæ ‡å¿—å¯ä»¥ç”¨æ¥å‘/etc/hostsæ·»åŠ é¢å¤–çš„è¡Œã€‚
>
> å¦‚æœä¸€ä¸ªå®¹å™¨è¢«è¿æ¥åˆ°é»˜è®¤çš„æ¡¥æ¥ç½‘ç»œå¹¶ä¸å…¶ä»–å®¹å™¨é“¾æ¥ï¼Œé‚£ä¹ˆè¯¥å®¹å™¨çš„/etc/hostsæ–‡ä»¶å°±ä¼šç”¨è¢«é“¾æ¥çš„å®¹å™¨çš„åç§°è¿›è¡Œæ›´æ–°ã€‚
>
> ç”±äºDockerå¯èƒ½ä¼šå®æ—¶æ›´æ–°å®¹å™¨çš„/etc/hostsæ–‡ä»¶ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µï¼šå®¹å™¨å†…çš„è¿›ç¨‹æœ€ç»ˆä¼šè¯»å–ä¸€ä¸ªç©ºçš„æˆ–ä¸å®Œæ•´çš„/etc/hostsæ–‡ä»¶ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå†æ¬¡é‡è¯•è¯»å–åº”è¯¥å¯ä»¥è§£å†³é—®é¢˜ã€‚

ä¹Ÿå°±æ˜¯è¯´Dockerä¼šå¯¹ `/etc/hosts` æ–‡ä»¶è¿›è¡Œç®¡ç†å¹¶ä¸”ä¼šä¸å®šæ—¶æ›´æ–°

æˆ‘çŒœæµ‹æ˜¯æˆ‘å¯åŠ¨æµ‹è¯•å®¹å™¨æ—¶dockerä¼šæ£€æŸ¥ç½‘ç»œå¹¶æ›´æ–° `/etc/hosts` æ–‡ä»¶å¯¼è‡´ç ´è§£å†…å®¹è¢«æ¸…é™¤å¯¼è‡´


## 3. Bugè§£å†³

### 3.1 --add-host

> å¦‚æœä½ åªæ˜¯å¯¹å·²æœ‰é•œåƒåšç®€å•ä¿®æ”¹ï¼Œå»ºè®®ä½¿ç”¨æ­¤ç§æ–¹å¼

åˆ›å»ºå®¹å™¨æ—¶ä½¿ç”¨ `docker run` å‘½ä»¤çš„ `--add-host` å‚æ•°æŒ‡å®š /etc/hosts å†…å®¹

å‘½ä»¤æ ¼å¼ï¼š

```shell
# host : ä¸»æœºåç§°
# ip   : ä¸»æœºIPåœ°å€
docker run --add-host host:ip
```


### 3.2 ä½¿ç”¨å¯åŠ¨è„šæœ¬

> å¦‚æœä½ ä½¿ç”¨Dockerfileæ„å»ºé•œåƒä¸”ä½¿ç”¨å¯åŠ¨è„šæœ¬åšåˆå§‹åŒ–æ“ä½œæ—¶å»ºè®®ä½¿ç”¨æ­¤ç§æ–¹å¼

ç¬¬äºŒç§æ–¹å¼æ˜¯æ„å»ºé•œåƒæ—¶æŒ‡å®šä¸€ä¸ªå¯åŠ¨è„šæœ¬ï¼Œæ¯æ¬¡å¯åŠ¨å®¹å™¨å‰æ£€æŸ¥ä¸€æ¬¡ `/etc/hosts` æ–‡ä»¶å†…å®¹å®Œæ•´æ€§

ä»¥AWVSç ´è§£æ•™ç¨‹ä¸ºåŸºç¡€ï¼Œä»¥ä¸‹ä¸ºä¸€ä¸ªshellå¯åŠ¨è„šæœ¬ä¾‹å­ï¼š

è¯¥å¯åŠ¨è„šæœ¬ä¼šåœ¨å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œï¼Œè„šæœ¬ä¼šæ£€æŸ¥ `/etc/hosts` æ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨ç ´è§£å†…å®¹

127.0.0.1 updates.acunetix.com
127.0.0.1 erp.acunetix.com

```bash
#!/bin/bash

# æ¯æ¬¡å¯åŠ¨å‰éƒ½æ£€æŸ¥ /etc/hosts æ–‡ä»¶, ç¡®ä¿å±è”½äº†AWVSæ›´æ–°æ£€æŸ¥
# é˜²æ­¢å®¹å™¨è¿ç§»å /etc/hosts æ–‡ä»¶å†…å®¹ä¸¢å¤±é€ æˆçš„æ‰«æä»»åŠ¡å¯åŠ¨å¤±è´¥
host1CheckResult=`cat /etc/hosts | grep updates.acunetix.com | tr -s [:space:]`
host2CheckResult=`cat /etc/hosts | grep erp.acunetix.com | tr -s [:space:]`
if [ -z "$host1CheckResult" ];then
   echo "127.0.0.1 updates.acunetix.com" >> /etc/hosts
fi
if [ -z "$host2CheckResult" ];then
    echo "127.0.0.1 erp.acunetix.com" >> /etc/hosts
fi

# å¯åŠ¨AWVS
su - acunetix -c "cd /home/acunetix/.acunetix/ && ./start.sh"
```

å°†æ­¤è„šæœ¬ä¿å­˜ä¸º `start.sh`


## 4. ä¸€äº›å‚è€ƒå‘½ä»¤ 

### 4.1 å°†å¯åŠ¨è„šæœ¬é™„åŠ åˆ°å·²æœ‰å®¹å™¨ 

å°†è„šæœ¬å¤åˆ¶åˆ°å®¹å™¨ä¸­ 

```shell
docker cp start.sh å®¹å™¨åç§°:è„šæœ¬å­˜å‚¨ç›®å½•
# ä¾‹å­
docker cp start.sh awvs-14:/root/
```

ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™ 

```shell
docker exec å®¹å™¨åç§° chmod +x è„šæœ¬è·¯å¾„
# ä¾‹å­
docker exec awvs-14 chmod +x /root/start.sh
```

åœæ­¢å®¹å™¨

```shell
docker stop å®¹å™¨åç§°
# ä¾‹å­
docker stop awvs-14
```

å°†å®¹å™¨æäº¤ä¸ºæ–°é•œåƒ

```shell
docker commit å®¹å™¨åç§° é•œåƒåç§°:tag
# ä¾‹å­
docker commit awvs-14 awvs:14
```

ä»¥æäº¤çš„é•œåƒä½œä¸ºåŸºç¡€å¯åŠ¨ä¸€ä¸ªæ–°é•œåƒï¼Œå¹¶ä»¥ `start.sh` ä½œä¸ºå¯åŠ¨è„šæœ¬

```shell
docker run -itd --name awvs-14-new awvs:14 /root/start.sh
```

### 4.2 ä½¿ç”¨Dockerfileæ„å»ºå¹¶å¯åŠ¨

```dockerfile
FROM ubuntu:20.04

WORKDIR /root/
COPY start.sh ./

RUN chmod +x ./start.sh

CMD ./start.sh
```

æ„å»ºé•œåƒ

```shell
docker build -t awvs:14 .
```

ä»¥é•œåƒä¸ºåŸºç¡€å¯åŠ¨å®¹å™¨

```shell
docker run -itd --name awvs-14-new awvs:14 
```